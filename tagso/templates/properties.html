{% extends "base.html" %}

{% block title %}Tagsonomy | Properties{% endblock %}

{% block scripts %}
<script>
    function filter_properties() {
      var input, filter, ul, li, i, spans, uri, name, txtValue;
      input = document.getElementById('property_search');
      filter = input.value.toUpperCase();
      ul = document.getElementById("property_list");
      li = ul.children;

      for (i = 0; i < li.length; i++) {
        spans = li[i].getElementsByTagName('span');
        uri = spans[0] ? (spans[0].textContent || spans[0].innerText) : '';
        name = spans[1] ? (spans[1].textContent || spans[1].innerText) : '';
        txtValue = uri + ' ' + name;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          li[i].style.display = "";
        } else {
          li[i].style.display = "none";
        }
      }
    }

    function delete_property(property_uri) {
      if (confirm('Are you sure you want to delete this property?')) {
        fetch('{{ url_for("properties.property_delete") }}', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ uri: property_uri })
        })
        .then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error deleting property');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting property');
        });
      }
    }

    function addAltLabelField(containerId) {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'alt-label-field';

        const input = document.createElement('input');
        input.type = 'text';
        input.name = 'alt_labels';
        input.placeholder = 'Alternative label';
        input.required = true;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = function() { removeAltLabelField(this); };

        newField.appendChild(input);
        newField.appendChild(removeBtn);
        container.appendChild(newField);
    }

    function removeAltLabelField(button) {
        button.parentElement.remove();
    }

    window.addEventListener('DOMContentLoaded', function() { 
      filter_properties(); 
    });
</script>
{% endblock %}

{% block content %}
<input type="search" 
       id="property_search" 
       value="{{ property_uri }}" 
       onkeyup="filter_properties()" 
       placeholder="Search for properties...">

<ul id="property_list">
    {% for property in properties %}
    <li>
        <div>
            <b>URI:</b> <span>{{ property.uri | safe }}</span>
        </div>
        <div>
            <b>Label:</b> <span>{{ property.name | safe }}</span>
        </div>
        {% if property.alt_labels %}
        <div>
            <b>Alternative Labels:</b>
            <ul>
                {% for alt_label in property.alt_labels %}
                <li>{{ alt_label | safe }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if property.domain %}
        <div>
            <b>Domain:</b> <a href="{{ url_for('concepts.concepts_get', concept_uri=property.domain) }}">{{ property.domain_label or property.domain }}</a>
        </div>
        {% endif %}
        {% if property.range %}
        <div>
            <b>Range:</b> <a href="{{ url_for('concepts.concepts_get', concept_uri=property.range) }}">{{ property.range_label or property.range }}</a>
        </div>
        {% endif %}
        <div>
            <b>Assigned Columns:</b>
            {% if property.assigned_columns %}
            <ul>
                {% for assignment in property.assigned_columns %}
                <li><a href="{{ url_for('columns.columns_get', column_uri=assignment.column_uri) }}">{{ assignment.column_name | default(assignment.column_uri, true) | safe }}</a> ({{ assignment.column_uri | safe }})</li>
                {% endfor %}
            </ul>
            {% else %}
            <span>None</span>
            {% endif %}
        </div>
        <a href="{{ url_for('properties.property_edit_get', uri=property.uri) }}"><button type="button">Edit</button></a>
        <button onclick="delete_property('{{ property.uri }}')">Delete</button>
        <a href="{{ url_for('assign.assign_get', selected_property_uri=property.uri) }}"><button type="button">Assign</button></a>
    </li>
    {% endfor %}
</ul>

<hr/>

<h2>New Property</h2>
<form action="{{ url_for('properties.properties_post') }}" method='post'>
    <label for="name">Property label:</label>
    <!-- TODO: rename to property label -->
    <input type="text" name="name" id="name" required/>
    
    <label for="uri">Property IRI (optional):</label>
    <input type="text" name="uri" id="uri"/>
    
    <label for="domain">Domain (optional):</label>
    <select name="domain" id="domain">
        <option value="">— None —</option>
        {% for concept in concepts %}
        <option value="{{ concept.uri }}">{{ concept.label or concept.uri }}</option>
        {% endfor %}
    </select>
    
    <label for="range">Range (optional):</label>
    <select name="range" id="range">
        <option value="">— None —</option>
        {% for concept in concepts %}
        <option value="{{ concept.uri }}">{{ concept.label or concept.uri }}</option>
        {% endfor %}
    </select>
    
    <label>Alternative Labels (skos:altLabel):</label>
    <div id="new_property_alt_labels_container"></div>
    <button type="button" onclick="addAltLabelField('new_property_alt_labels_container')">Add Alternative Label</button>
    
    <input type="submit" value="Create"/>
</form>
{% endblock %}
