{% extends "base.html" %}

{% block title %}Tagsonomy | Concepts{% endblock %}

{% block scripts %}
<script>
    function filter_concepts() {
      var input, filter, ul, li, i, spans, uri, name, txtValue;
      input = document.getElementById('concept_search');
      filter = input.value.toUpperCase();
      ul = document.getElementById("concept_list");
      li = ul.getElementsByTagName('li');

      for (i = 0; i < li.length; i++) {
        spans = li[i].getElementsByTagName('span');
        uri = spans[0] ? (spans[0].textContent || spans[0].innerText) : '';
        name = spans[1] ? (spans[1].textContent || spans[1].innerText) : '';
        txtValue = uri + ' ' + name;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          li[i].style.display = "";
        } else {
          li[i].style.display = "none";
        }
      }
    }

    function delete_concept(concept_uri) {
      if (confirm('Are you sure you want to delete this concept?')) {
        fetch('{{ url_for("concepts.concept_delete") }}', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ uri: concept_uri })
        })
        .then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error deleting concept');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting concept');
        });
      }
    }

    const USER_NS = "{{ user_ns }}";

    function generate_uri_from_label(label) {
      if (!label) return '';
      return USER_NS + encodeURIComponent(label);
    }

    function update_uri_from_label() {
      const labelInput = document.getElementById('label');
      const uriInput = document.getElementById('uri');
      uriInput.value = generate_uri_from_label(labelInput.value);
    }

    window.addEventListener('DOMContentLoaded', function() { 
      filter_concepts();
    });
</script>
{% endblock %}

{% block content %}
<input type="search" 
       id="concept_search" 
       value="{{ concept_uri }}" 
       onkeyup="filter_concepts()" 
       placeholder="Search for concepts...">

<ul id="concept_list">
    {% for concept in concepts %}
    <li>
        <div>
            <b>URI:</b> <span>{{ concept.uri | safe }}</span>
        </div>
        <div>
            <b>Name:</b> <span>{{ concept.name | safe }}</span>
        </div>
        <div>
            <b>Assigned Tables:</b>
            {% if concept.assigned_tables %}
            <ul>
                {% for assignment in concept.assigned_tables %}
                <li>{{ assignment.table_name | default(assignment.table_uri, true) | safe }} ({{ assignment.table_uri | safe }})</li>
                {% endfor %}
            </ul>
            {% else %}
            <span>None</span>
            {% endif %}
        </div>
        <div>
            <b>Related Properties:</b> <span>TODO</span>
        </div>
        <button onclick="delete_concept('{{ concept.uri }}')">Delete</button>
        <a href="{{ url_for('assign.assign_get', selected_concept_uri=concept.uri) }}"><button type="button">Assign</button></a>
    </li>
    {% endfor %}
</ul>

<hr/>

<h2>New Concept</h2>
<form action="{{ url_for('concepts.concepts_post') }}" method='post'>
    <label for="label">Label:</label>
    <input type="text" name="label" id="label" oninput="update_uri_from_label()" required/>
    
    <label for="uri">IRI:</label>
    <input type="text" name="uri" id="uri"/>

    <label for="comment">Comment:</label>
    <input type="text" name="comment" id="comment"/>

    <input type="radio" name="type" id="rdfs_class" value="rdfs_class" checked>
    <label for="rdfs_class">RDFS Class</label>
    <input type="radio" name="type" id="skos_concept" value="skos_concept">
    <label for="skos_concept">SKOS Concept</label>
    
    <input type="submit" value="Create"/>
</form>
{% endblock %}

